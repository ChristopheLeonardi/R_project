---
title: "R Notebook"
output: html_notebook
---

```{r}
source("Traitement/traitement_acp.R")
library(stats)
library(readxl)
library(dplyr)
library(missMDA)
library(pracma)
library(corrplot)
library(lubridate)
library(missForest)
library(FactoMineR)
library(wakefield)

library(ggpubr)
library(factoextra)
library(cluster)
```

```{r}
library(shiny)

ui <- fluidPage(
  titlePanel("Projet Room 2"),
  sidebarLayout(
    sidebarPanel(
      # Load File
      wellPanel(
        titlePanel("Chargement du jeu de données"),
        fileInput("file", "Choisissez un fichier csv",
                  accept = c("text/csv", "text/comma-separated-values,text/plain", ".csv")),
        radioButtons('sep', 'Separator', c(Comma=',', Semicolon=';'), ';'),
      ),
      
      # ACP
      wellPanel(
        titlePanel("ACP"),
        checkboxGroupInput("columns", "Sélectionnez les colonnes à conserver",
                           choices = colnames(data())), 
        actionButton("acp", "Calculer l'ACP"),
      ),
      
      # Regression Linéare
      wellPanel(
        titlePanel("Régression Linéaire"),
        selectInput("var_inco_lin", "Variable à expliquer :", choices = c(colnames(data()))),
  
        checkboxGroupInput("var_exp_lin", "Variable(s) explicatives",
                           choices = colnames(data())), 
        actionButton("reg_lin", "Voir la régression linéaire multiple"),
      ),
            
      # Regression logistique
      wellPanel(
        titlePanel("Régression Logistique"),
        selectInput("var_inco_log", "Variable à expliquer :", choices = c(colnames(data()))),
  
        checkboxGroupInput("var_exp_lon", "Variable(s) explicative(s)",
                           choices = colnames(data())), 
        actionButton("reg_lon", "Voir la régression logistique"),
      ),
            
      # K-means
      wellPanel(
        titlePanel("K-means"),
  
        checkboxGroupInput("var_quant", "Variable(s) quantitative(s) : ",
                           choices = colnames(data())), 
        selectInput("var_shape", "Variable de shape :", choices = c(colnames(data()))),
        sliderInput("n_cluster", "Nombre de clusters:", min = 1, max = 10, value = 5),
        
        actionButton("k_means", "Voir le K-means"),
      ),
      
    ),
    mainPanel(
      tableOutput("data"),
      
      plotOutput("acp_ind"),
      plotOutput("acp_var"),
      
      textOutput("lin"),
      textOutput("lon"),
      plotOutput("k_means")
      
    )
  )
)

```

```{r}
server <- function(input, output,session) {
  data <- reactive({
    req(input$file)
    df <- read.csv(input$file$datapath, header = TRUE, sep = input$sep)
    
    # ACP
    updateCheckboxGroupInput(session, "columns", "Sélectionnez les colonnes à conserver", 
                             choices = colnames(df),
                             selected = colnames(df))

    # Régression Linéaire
    updateSelectInput(session, "var_inco_lin", "Variable à expliqué :", 
                             choices = colnames(df))
    
    updateCheckboxGroupInput(session, "var_exp_lin", "Variable(s) explicative(s)", 
                             choices = colnames(df),
                             selected = colnames(df))
    
    # Régression Logistique
    updateSelectInput(session, "var_inco_log", "Variable à expliquer :", 
                             choices = colnames(df))
    
    updateCheckboxGroupInput(session, "var_exp_lon", "Variable(s) explicative(s)", 
                             choices = colnames(df),
                             selected = colnames(df))
    
    # K-means
    updateCheckboxGroupInput(session, "var_quant", "Variable(s) quantitative(s) : ", 
                             choices = colnames(df),
                             selected = colnames(df))
    df
  })
  
  # Add event ACP
  observeEvent(input$acp, {
    
    removeUI(selector = ".shiny-bound-output:not(#acp) *")

    df_selected <- data()[, input$columns]
    data_acp_num <- df_selected[sapply(df_selected, is.numeric)]
    data_imputed_acp <- missForest(data_acp_num)
    data_fitted <- data_imputed_acp$ximp
    
    res.pca <- PCA(data_fitted, graph=T)
    
    output$acp_ind <- renderPlot({ 

      info <- getCurrentOutputInfo()
      plot.PCA(res.pca, choix="ind")

      
    })
    
    output$acp_var <- renderPlot({ 
      
      info <- getCurrentOutputInfo()
      PCA(data_fitted)
      
    })

    
  })
    
  # Add Event Régression linéaire
  observeEvent(input$reg_lin, {
    output$lin <- renderText({ 
      "lin"
    })
  })

  # Add Event Régression Longitudinale
  observeEvent(input$reg_lon, {
    output$lon <- renderText({ 
      p('My first paragraph, with some ', strong('bold'), ' text.')
    })
  })
    
  # Add Event K-means
  observeEvent(input$k_means, {
    
    removeUI(selector = ".shiny-bound-output:not(#k_means) *")
    
    df_selected <- data()[, input$var_quant]
    data_acp_num <- df_selected[sapply(df_selected, is.numeric)]
    data_acp_num <- scale(data_acp_num)

    data_imputed_acp <- missForest(data_acp_num)
    data_fitted <- data_imputed_acp$ximp
    
    set.seed(123)
    resultat_kmeans <- kmeans(data_fitted, 
                              centers = 3, 
                              iter.max = 10, 
                              nstart = 25)
    
    output$k_means <- renderPlot({ 

      #info <- getCurrentOutputInfo()
      #PCA(data_fitted)
      fviz_cluster(resultat_kmeans, data = data_fitted,
                   palette = c("#2E9FDF", "#00AFBB", "#E7B800"), 
                   geom = "point",
                   ellipse.type = "convex", 
                   ggtheme = theme_bw()
                   )
    })
  })
  
  output$data <- renderTable({
    removeUI(selector = ".shiny-bound-output:not(#data) *")
    data()[, input$columns]
  }, server = TRUE)
}


```

```{r}
shinyApp(ui = ui, server = server)
```
